/**
 * @file Firestore Security Rules for Brain Battle Quiz Game
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and quiz history,
 * and restricts write access to the leaderboard to prevent unauthorized modifications.
 * Read access to questions and leaderboard entries is public.
 *
 * Data Structure:
 * - /users/{userId}: User profile data.
 * - /users/{userId}/quizHistory/{quizHistoryId}: Quiz history for each user.
 * - /questions/{questionId}: Quiz questions (publicly readable, admin-writeable).
 * - /leaderboard/{leaderboardEntryId}: Leaderboard entries (publicly readable, restricted writes).
 *
 * Key Security Decisions:
 * - User data and quiz history are strictly owned by the user, enforced by path-based authentication.
 * - Leaderboard writes are restricted to prevent tampering. Consider using a trusted server environment to manage leaderboard entries.
 * - Questions are publicly readable to allow all users to access quiz content.
 * - The rules do not implement user listing.
 *
 * Denormalization for Authorization:
 *  N/A - No denormalization is used in these rules.
 *
 * Structural Segregation:
 *  N/A - Draft and published content is not considered.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces read/write access to user profiles based on user ID. Only the authenticated user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create, update, delete) An authenticated user with ID 'user123' creates their profile at /users/user123.
     * @allow (get, list) An authenticated user with ID 'user123' reads their profile at /users/user123.
     * @deny (create, update, delete) An authenticated user with ID 'user456' attempts to create/update/delete the profile at /users/user123.
     * @deny (get, list) An unauthenticated user attempts to read the profile at /users/user123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == userId;
      allow delete: if isExistingOwner(userId);

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      /**
       * @description Enforces read/write access to quiz history based on user ID. Only the authenticated user can read/write their own quiz history.
       * @path /users/{userId}/quizHistory/{quizHistoryId}
       * @allow (create, update, delete) An authenticated user with ID 'user123' creates their quiz history at /users/user123/quizHistory/quiz1.
       * @allow (get, list) An authenticated user with ID 'user123' reads their quiz history at /users/user123/quizHistory/quiz1.
       * @deny (create, update, delete) An authenticated user with ID 'user456' attempts to create/update/delete the quiz history at /users/user123/quizHistory/quiz1.
       * @deny (get, list) An unauthenticated user attempts to read the quiz history at /users/user123/quizHistory/quiz1.
       * @principle Enforces document ownership for all operations.
       */
      match /quizHistory/{quizHistoryId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId) && resource.data.userId == userId;
        allow delete: if isExistingOwner(userId);

        function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
        }
      }
    }

    /**
     * @description Allows public read access to quiz questions, but restricts write access.
     * @path /questions/{questionId}
     * @allow (get, list) Any user, authenticated or not, can read the questions.
     * @deny (create, update, delete) Any user attempts to create/update/delete a question.
     * @principle Allows public read access with restricted write access.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Implement admin role check
    }

    /**
     * @description Allows public read access to the leaderboard, but restricts write access to prevent tampering.
     * @path /leaderboard/{leaderboardEntryId}
     * @allow (get, list) Any user, authenticated or not, can read the leaderboard.
     * @deny (create, update, delete) Any user attempts to create/update/delete a leaderboard entry.
     * @principle Allows public read access with restricted write access.
     */
    match /leaderboard/{leaderboardEntryId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Implement authorized user check
    }
  }
}