/**
 * @file Firestore Security Rules for Brain Battle Quiz Game
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles and quiz history,
 * and restricts write access to the leaderboard, allowing public read access.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user themselves.
 * - /users/{userId}/quizHistory/{quizHistoryId}: Quiz history entries, accessible only by the user themselves.
 * - /questions/{questionId}: Quiz questions, publicly readable but writable by admins only (currently not implemented, write rules are set to false).
 * - /leaderboard/{leaderboardEntryId}: Leaderboard entries, publicly readable but writable by authenticated users, score can be modified by the same user.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Read-only collections (questions, leaderboard) are publicly readable.
 * - Default security posture for ambiguous relationships is strict owner-only access.
 *
 * Denormalization for Authorization: Not explicitly used, but the data structure
 * supports future denormalization (e.g., adding 'ownerId' to quizHistory).
 *
 * Structural Segregation: Public (questions, leaderboard) and private (user data)
 * are stored in separate top-level collections, enhancing security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles. Only the user with the matching userId can read and write their own profile.
     * @path /users/{userId}
     * @allow (create) User 'user_abc' can create their profile if request.auth.uid == 'user_abc'.
     * @allow (get) User 'user_abc' can read their profile if request.auth.uid == 'user_abc'.
     * @allow (update) User 'user_abc' can update their profile if request.auth.uid == 'user_abc'.
     * @allow (delete) User 'user_abc' can delete their profile if request.auth.uid == 'user_abc'.
     * @deny (create) User 'user_xyz' cannot create profile for 'user_abc'.
     * @deny (get) User 'user_xyz' cannot read 'user_abc' profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      // isOwner function checks if the requested userId matches the authenticated user's id
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Enforces access control for quiz history entries. Only the user with the matching userId can read and write their own quiz history.
     * @path /users/{userId}/quizHistory/{quizHistoryId}
     * @allow (create) User 'user_abc' can create quiz history entry under their profile.
     * @allow (get) User 'user_abc' can read their quiz history entry.
     * @allow (update) User 'user_abc' can update their quiz history entry.
     * @allow (delete) User 'user_abc' can delete their quiz history entry.
     * @deny (create) User 'user_xyz' cannot create quiz history for 'user_abc'.
     * @deny (get) User 'user_xyz' cannot read 'user_abc' quiz history.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/quizHistory/{quizHistoryId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows public read access to quiz questions, but restricts write access.
     * @path /questions/{questionId}
     * @allow (get) Any user can read quiz questions.
     * @allow (list) Any user can list quiz questions.
     * @deny (create) No one can create questions directly (admin only through backend).
     * @deny (update) No one can update questions directly (admin only through backend).
     * @deny (delete) No one can delete questions directly (admin only through backend).
     * @principle Allows public reads, restricts writes.
     */
    match /questions/{questionId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to the leaderboard, but restricts write access to authenticated users.
     * @path /leaderboard/{leaderboardEntryId}
     * @allow (get) Any user can read the leaderboard.
     * @allow (list) Any user can list the leaderboard entries.
     * @allow (create) Only authenticated users can create leaderboard entries.
     * @allow (update) Only the user who created the entry can update their score.
     * @allow (delete) No one can delete leaderboard entries.
     * @deny (create) Non-authenticated users cannot create leaderboard entries.
     * @deny (update) Users cannot update other users' leaderboard scores.
     * @deny (delete) No one can delete leaderboard entries.
     * @principle Allows public reads, restricts writes to authenticated users, owner can modify only score.
     */
    match /leaderboard/{leaderboardEntryId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(leaderboardEntryId) {
            return request.auth != null && resource.data.userId == request.auth.uid;
        }
          
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && request.resource.data.userId == resource.data.userId;
        allow delete: if false;
    }
  }
}