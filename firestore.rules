/**
 * @file Firebase Security Rules for Brain Battle Quiz Game
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user profiles and quiz history,
 * while providing public read access to questions and leaderboard data.  Write access to questions is
 * restricted, and write access to the leaderboard is limited to the owning user. Data validation is minimized
 * to enable rapid prototyping and iteration.  Authorization decisions are based on the authenticated
 * user's UID and path-based ownership.
 *
 * @data_structure
 * - /users/{userId}: Stores user profile information. Only the user can read/write their own profile.
 * - /users/{userId}/quizHistory/{quizHistoryId}: Stores quiz history for each user.  Only the user can
 *   read/write their own quiz history.
 * - /questions/{questionId}: Stores quiz questions. Publicly readable, but writeable only by admins (TODO).
 * - /leaderboard/{userId}: Stores leaderboard entries. Publicly readable, writeable only by the user.
 *
 * @key_security_decisions
 * - User listing is implicitly denied because there is no rule allowing it.
 * - Public read access is granted to the /questions and /leaderboard collections.
 * - Owner-only write access is enforced via path-based ownership.
 * - The rules do not enforce strong data validation to facilitate rapid prototyping.
 *   However, basic ownership checks are performed during writes to maintain data integrity.
 *
 * @denormalization_for_authorization No denormalization is used in the current ruleset. The path-based
 *   ownership model obviates the need for denormalization.
 *
 * @structural_segregation Public and private data are stored in separate collections, with user-specific
 *   data nested under the /users/{userId} path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents. Only the user can read and write their own profile.
     * @path /users/{userId}
     * @allow (create) Signed-in user creates their own profile with matching user ID in the document.
     *   Example: request.auth.uid = "user123" and request.resource.data.id = "user123"
     * @deny (create) Signed-in user attempts to create a profile for a different user.
     *   Example: request.auth.uid = "user123" and request.resource.data.id = "user456"
     * @allow (get, list, update, delete) Signed-in user reads/writes their own profile based on the path.
     *   Example: request.auth.uid = "user123" and accessing /users/user123
     * @deny (get, list, update, delete) Signed-in user attempts to read/write another user's profile.
     *   Example: request.auth.uid = "user123" and accessing /users/user456
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow get, update, delete: if isOwner(userId) && resource.data.id == userId;
      allow list: if false; // User listing is not allowed
    }

    /**
     * @description Controls access to quiz history documents for each user.
     * Only the user can read and write their own quiz history.
     * @path /users/{userId}/quizHistory/{quizHistoryId}
     * @allow (create) Signed-in user creates a new quiz history entry under their own user ID.
     *   Example: request.auth.uid = "user123" and the path is /users/user123/quizHistory/quiz1
     * @deny (create) Signed-in user attempts to create a quiz history entry under a different user ID.
     *   Example: request.auth.uid = "user123" and the path is /users/user456/quizHistory/quiz1
     * @allow (get, list, update, delete) Signed-in user reads/writes their own quiz history entries.
     *   Example: request.auth.uid = "user123" and accessing /users/user123/quizHistory/quiz1
     * @deny (get, list, update, delete) Signed-in user attempts to read/write another user's quiz history entries.
     *   Example: request.auth.uid = "user123" and accessing /users/user456/quizHistory/quiz1
     * @principle Enforces document ownership for all operations on quiz history entries.
     */
    match /users/{userId}/quizHistory/{quizHistoryId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get, list, update, delete: if isOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Controls access to quiz question documents.  Read access is public, write access is restricted.
     * @path /questions/{questionId}
     * @allow (get, list) Any user can read the question data.
     * @deny (create, update, delete) No user can create, update, or delete questions (TODO: implement admin role).
     * @principle Allows public read access while restricting write access.
     */
    match /questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add admin role validation
    }

    /**
     * @description Controls access to leaderboard entry documents. Read access is public, and users can only update their own entry.
     * @path /leaderboard/{userId}
     * @allow (get, list) Any user can read the leaderboard data.
     * @allow (create, update, delete) Signed-in user can create, update, or delete their own leaderboard entry.
     *   Example: request.auth.uid = "user123" and the path is /leaderboard/user123
     * @deny (create, update, delete) Signed-in user attempts to create, update, or delete another user's leaderboard entry.
     *   Example: request.auth.uid = "user123" and the path is /leaderboard/user456
     * @principle Allows public read access while restricting write access to the owning user.
     */
    match /leaderboard/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get, list: if true;
      allow create, update, delete: if isOwner(userId);
    }
  }
}