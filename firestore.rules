/**
 * @file Firebase Security Rules for Brain Battle Quiz Game
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user-specific data
 * and allows public read access for leaderboard and question data. Write access is restricted
 * to owners or, in the case of questions, is forbidden.
 *
 * @data_structure
 *   - /users/{userId}: Stores user profiles, accessible only by the user themselves.
 *   - /users/{userId}/quizHistory/{quizHistoryId}: Stores quiz history, accessible only by the user.
 *   - /questions/{questionId}: Stores quiz questions, publicly readable, but write-protected.
 *   - /leaderboard/{userId}: Stores leaderboard entries, publicly readable, writable only by the user.
 *
 * @key_security_decisions
 *   - User listing is disallowed.
 *   - Read-only collections (questions) are publicly readable.
 *   - Ambiguous relationships default to strict owner-only access.
 *
 * @denormalization_for_authorization None needed - using path based ownership.
 * @structural_segregation Using separate collections for private (user-specific) and public (questions, leaderboard) data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profiles. Only the user can create, read, update, or delete their own profile.
     * @path /users/{userId}
     * @allow (create) - User 'UXMni...' can create their profile with matching userId
     * @allow (get, update, delete) - User 'UXMni...' can get, update, or delete their profile.
     * @deny (create) - User 'OtherUser' cannot create a profile for 'UXMni...'
     * @deny (update, delete) - User 'OtherUser' cannot update or delete 'UXMni...' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the requested userId matches the authenticated user's ID
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Check if the requested userId matches the authenticated user's ID and resource exists.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages quiz history for a user. Only the user can create, read, update, or delete their own quiz history entries.
     * @path /users/{userId}/quizHistory/{quizHistoryId}
     * @allow (create) - User 'UXMni...' can create a quiz history entry under their profile.
     * @allow (get, update, delete) - User 'UXMni...' can get, update, or delete their quiz history entries.
     * @deny (create) - User 'OtherUser' cannot create a quiz history entry for 'UXMni...'.
     * @deny (update, delete) - User 'OtherUser' cannot update or delete 'UXMni...' quiz history.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/quizHistory/{quizHistoryId} {
      // Check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the requested userId matches the authenticated user's ID
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Check if the requested userId matches the authenticated user's ID and resource exists.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages quiz questions. Read access is public, but write access is denied to all.
     * @path /questions/{questionId}
     * @allow (get, list) - Any user can read quiz questions.
     * @deny (create, update, delete) - No user can create, update, or delete questions.
     * @principle Allows public read access while restricting write access.
     */
    match /questions/{questionId} {
      allow get: if true;
      allow list: if true;

      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages leaderboard entries. Read access is public, but write access is restricted to the user.
     * @path /leaderboard/{userId}
     * @allow (get, list) - Any user can read leaderboard entries.
     * @allow (create, update) - Only the user can create or update their own leaderboard entry.
     * @deny (create, update, delete) - User 'OtherUser' cannot modify 'UXMni...' leaderboard entry.
     * @principle Allows public read access while enforcing ownership for writes.
     */
    match /leaderboard/{userId} {
      // Check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the requested userId matches the authenticated user's ID
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Check if the requested userId matches the authenticated user's ID and resource exists.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if false; // Deletion not allowed
    }
  }
}